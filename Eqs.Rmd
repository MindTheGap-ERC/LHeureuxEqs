---
title: "Formulations Cont. ADZ & Initial porosity profile"
output: html_document
date: "2023-07-04"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Initial Porosity Profile

The initial porosity profile is usually modelled based on an exponential decrease based on the equation
```{=latex}
\begin{equation}
\Phi(d) = a_{por} \exp(- b_{por} d) + c_{por}
\end{equation}

```
Where $d$ is depth, $\Phi(d)$ is porosity at depth $d$, and $a_{por}$,$b_{por}$, and $c_{por}$ are empirical parameters with the following interpretations:

* $c_{por}$ is the limit porosity
* $b_{por}$ is a "Compressibility constant"that determines how fast porosity approaches $c_{por}$ with depth
* $a_{por} + c_{por}$ is the porosity at the sediment surface

The old parametrization can be obtained by setting $a_{por}=b_{por}=0$ and $c_{por}=\Phi_{ini}$

This is an empirical equation. Parametrizations might deviate, compilations of parameters are available in the Literature.

## Continuous ADZ
A smooth ADZ can be constructed the following way:
1. Start with the function
```{=Latex}
\begin{equation}
f(x) = 
\begin{cases}
\exp(t^{-ax})  & \text{for} x>0 \\
0 & \text{ else}
\end{cases}
\end{equation}
```
here, $a>0$ is a parameter. It determines how fast the onset of the ADZ is. In standard constructions, $a = 1$.

2. Define the two cutoff functions
```{=Latex}
\begin{equation}
h_1(x) = 
\frac{f(r_1 - x)}{f(r_2 - x) + f(x - r_1)}
\end{equation}
```
and 
```{=Latex}
\begin{equation}
h_2(x) = 
\frac{f(- r_3 + x)}{f(- r_4 + x) + f( - x + r_3)}
\end{equation}
```

Then the smooth ADZ is given by the equation
```{=Latex}
\begin{equation}
h(x) = h_1(x) h_2(x)
\end{equation}
```

Parameters are $r_4 < r_3 < r_1 < r2$ where
* $r_4$ is where first aragonite dissolution starts
* $r_3$ depth where Aragonite dissolution reaches its maximum for the first time
* $r_1$ deth where Aragomnite dissolution decreases again for the forst time
* $r_2$ depth where Aragonite dissolution drops to zero again

(NOTE: Reorder parameter indices, check implementations - @ Niklas)

This formulation of the ADZ id based on [this discussion](https://math.stackexchange.com/questions/101480/are-there-other-kinds-of-bump-functions-than-e-frac1x2-1) and [this book, p. 41 - 43](https://doi.org/10.1007/978-1-4419-9982-5). By construction, it has continuous derivatives of all orders. Open questions are:

* Do we need an expression for the (n-th) derivative of this equation for the implementation?
* Is it necessary to calculate function values every iteration? If no, can we store function values in an array before iteration and reuse them?
* If function values need to be calculated ever iteration, is the expression numerically stable and sufficiently fast? (I have  some concerns about the $\exp(-x)$ terms and division by small numbers here - Niklas)
* If not, look for alternative expressions with potentially lower order of continuous differentiability. (Comsol uses 2nd order continuous bump functions, this might be an option -Niklas)